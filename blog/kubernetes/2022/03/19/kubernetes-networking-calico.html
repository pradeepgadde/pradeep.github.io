<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kubernetes Networking with Calico CNI - Pradeep Gadde</title>
<meta name="description" content="Kubernetes Networking with Calico CNI">


  <meta name="author" content="Kubernetes">
  
  <meta property="article:author" content="Kubernetes">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Pradeep Gadde">
<meta property="og:title" content="Kubernetes Networking with Calico CNI">
<meta property="og:url" content="https://www.pradeepgadde.com/blog/kubernetes/2022/03/19/kubernetes-networking-calico.html">


  <meta property="og:description" content="Kubernetes Networking with Calico CNI">



  <meta property="og:image" content="https://www.pradeepgadde.com/blog/assets/images/calico.png">





  <meta property="article:published_time" content="2022-03-19T10:55:04+05:30">






<link rel="canonical" href="https://www.pradeepgadde.com/blog/kubernetes/2022/03/19/kubernetes-networking-calico.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Pradeep Gadde",
      "url": "https://www.pradeepgadde.com/blog/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Pradeep Gadde Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/blog/"><img src="/blog/assets/images/qr.gif" alt="Pradeep Gadde"></a>
        
        <a class="site-title" href="/blog/">
          Pradeep Gadde
          <span class="site-subtitle">Be Curious!</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/year-archive/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/tags/">Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.pradeepgadde.com/blog/">
        <img src="/blog/assets/images/kubernetes.png" alt="Kubernetes" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.pradeepgadde.com/blog/" itemprop="url">Kubernetes</a>
    </h3>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
    
      
      <h3>Blog</h3>
      <p>Checkout other topics</p>

      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Kubernetes</span>
        

        
        <ul>
          
            <li><a href="/blog/">Kubernetes Core Concepts</a></li>
          
            <li><a href="/blog/">Kubernetes Scheduling</a></li>
          
            <li><a href="/blog/">Kubernetes Application Life Cycle Management</a></li>
          
            <li><a href="/blog/">Kubernetes Storage</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">OpenShift</span>
        

        
        <ul>
          
            <li><a href="/blog/">CodeReadyContainers</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Automation</span>
        

        
        <ul>
          
            <li><a href="/blog/">Jenkins</a></li>
          
            <li><a href="/blog/">NITA</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Networking</span>
        

        
        <ul>
          
            <li><a href="/blog/">EVPN-VXLAN</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
    
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kubernetes Networking with Calico CNI">
    <meta itemprop="description" content="Kubernetes Networking with Calico CNI">
    <meta itemprop="datePublished" content="2022-03-19T10:55:04+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://www.pradeepgadde.com/blog/kubernetes/2022/03/19/kubernetes-networking-calico.html" class="u-url" itemprop="url">Kubernetes Networking with Calico CNI
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-03-19T10:55:04+05:30">March 19, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          22 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <p>Kubernetes Networking with Calico CNI</p>

<p>Let us build another minikube cluster, this time with the Calico CNI. Minikube supports many CNIs.</p>

<p>From the <code class="language-plaintext highlighter-rouge">minikube start -h</code> output, we can see the supported CNI plug-ins list.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">--cni</span><span class="o">=</span><span class="s1">''</span>: CNI plug-in to use. Valid options: auto, bridge, calico, cilium, flannel, kindnet, or path to a CNI
manifest <span class="o">(</span>default: auto<span class="o">)</span>
</code></pre></div></div>
<p>Start the 3-node minikube cluster with <code class="language-plaintext highlighter-rouge">calico</code> CNI plugin.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube start <span class="nt">--nodes</span><span class="o">=</span>3 <span class="nt">--cni</span><span class="o">=</span>calico
üòÑ  minikube v1.25.2 on Darwin 12.2.1
‚ú®  Automatically selected the hyperkit driver
üëç  Starting control plane node minikube <span class="k">in </span>cluster minikube
üî•  Creating hyperkit VM <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>2200MB, <span class="nv">Disk</span><span class="o">=</span>20000MB<span class="o">)</span> ...
üê≥  Preparing Kubernetes v1.23.3 on Docker 20.10.12 ...
    ‚ñ™ kubelet.housekeeping-interval<span class="o">=</span>5m
    ‚ñ™ Generating certificates and keys ...
    ‚ñ™ Booting up control plane ...
    ‚ñ™ Configuring RBAC rules ...
üîó  Configuring Calico <span class="o">(</span>Container Networking Interface<span class="o">)</span> ...
üîé  Verifying Kubernetes components...
    ‚ñ™ Using image gcr.io/k8s-minikube/storage-provisioner:v5
üåü  Enabled addons: default-storageclass, storage-provisioner

üëç  Starting worker node minikube-m02 <span class="k">in </span>cluster minikube
üî•  Creating hyperkit VM <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>2200MB, <span class="nv">Disk</span><span class="o">=</span>20000MB<span class="o">)</span> ...
üåê  Found network options:
    ‚ñ™ <span class="nv">NO_PROXY</span><span class="o">=</span>172.16.30.6
üê≥  Preparing Kubernetes v1.23.3 on Docker 20.10.12 ...
    ‚ñ™ <span class="nb">env </span><span class="nv">NO_PROXY</span><span class="o">=</span>172.16.30.6
üîé  Verifying Kubernetes components...

üëç  Starting worker node minikube-m03 <span class="k">in </span>cluster minikube
üî•  Creating hyperkit VM <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>2200MB, <span class="nv">Disk</span><span class="o">=</span>20000MB<span class="o">)</span> ...
üåê  Found network options:
    ‚ñ™ <span class="nv">NO_PROXY</span><span class="o">=</span>172.16.30.6,172.16.30.7
üê≥  Preparing Kubernetes v1.23.3 on Docker 20.10.12 ...
    ‚ñ™ <span class="nb">env </span><span class="nv">NO_PROXY</span><span class="o">=</span>172.16.30.6
    ‚ñ™ <span class="nb">env </span><span class="nv">NO_PROXY</span><span class="o">=</span>172.16.30.6,172.16.30.7
üîé  Verifying Kubernetes components...
üèÑ  Done! kubectl is now configured to use <span class="s2">"minikube"</span> cluster and <span class="s2">"default"</span> namespace by default
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>
<p>Verify the cluster node IPs: <code class="language-plaintext highlighter-rouge">172.16.30.6</code>, <code class="language-plaintext highlighter-rouge">172.16.30.7</code>, and <code class="language-plaintext highlighter-rouge">172.16.30.8</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide
NAME           STATUS   ROLES                  AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE              KERNEL-VERSION   CONTAINER-RUNTIME
minikube       Ready    control-plane,master   22m   v1.23.3   172.16.30.6   &lt;none&gt;        Buildroot 2021.02.4   4.19.202         docker://20.10.12
minikube-m02   Ready    &lt;none&gt;                 20m   v1.23.3   172.16.30.7   &lt;none&gt;        Buildroot 2021.02.4   4.19.202         docker://20.10.12
minikube-m03   Ready    &lt;none&gt;                 17m   v1.23.3   172.16.30.8   &lt;none&gt;        Buildroot 2021.02.4   4.19.202         docker://20.10.12
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>Verify the list of Pods in all namespaces.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get pods <span class="nt">-A</span> <span class="nt">-o</span> wide
NAMESPACE     NAME                                       READY   STATUS    RESTARTS        AGE     IP            NODE           NOMINATED NODE   READINESS GATES
kube-system   calico-kube-controllers-8594699699-dztlm   1/1     Running   0               6m50s   10.88.0.3     minikube       &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-gqvw6                          1/1     Running   1 <span class="o">(</span>2m54s ago<span class="o">)</span>   4m38s   172.16.30.7   minikube-m02   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-qdbcf                          1/1     Running   0               6m50s   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-sw74l                          1/1     Running   0               114s    172.16.30.8   minikube-m03   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-64897985d-58btq                    1/1     Running   0               6m50s   10.88.0.2     minikube       &lt;none&gt;           &lt;none&gt;
kube-system   etcd-minikube                              1/1     Running   0               7m1s    172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-minikube                    1/1     Running   0               7m1s    172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-minikube           1/1     Running   0               7m1s    172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-7k4lb                           1/1     Running   0               114s    172.16.30.8   minikube-m03   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-gm2dh                           1/1     Running   0               4m38s   172.16.30.7   minikube-m02   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-hvkqd                           1/1     Running   0               6m50s   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-minikube                    1/1     Running   0               7m1s    172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-system   storage-provisioner                        1/1     Running   1 <span class="o">(</span>2m26s ago<span class="o">)</span>   6m47s   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>
<p>There are two Pods using the 10.88.0.X subnet (<code class="language-plaintext highlighter-rouge">calico-kube-controllers</code> and <code class="language-plaintext highlighter-rouge">coredns</code> Pods ).</p>

<p>Login to the <code class="language-plaintext highlighter-rouge">controlplane</code> node and check the CNI directory.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ cat /etc/cni/net.d/
.keep                      10-calico.conflist         87-podman-bridge.conflist  calico-kubeconfig
$ cat /etc/cni/net.d/10-calico.conflist
{
  "name": "k8s-pod-network",
  "cniVersion": "0.3.1",
  "plugins": [
    {
      "type": "calico",
      "log_level": "info",
      "log_file_path": "/var/log/calico/cni/cni.log",
      "datastore_type": "kubernetes",
      "nodename": "minikube",
      "mtu": 0,
      "ipam": {
          "type": "calico-ipam"
      },
      "policy": {
          "type": "k8s"
      },
      "kubernetes": {
          "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
      }
    },
    {
      "type": "portmap",
      "snat": true,
      "capabilities": {"portMappings": true}
    },
    {
      "type": "bandwidth",
      "capabilities": {"bandwidth": true}
    }
  ]
}$
</span></code></pre></div></div>
<p>Apart from the Calico , there is a config file for Podman as well. Let us check that as well.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /etc/cni/net.d/87-podman-bridge.conflist
<span class="o">{</span>
  <span class="s2">"cniVersion"</span>: <span class="s2">"0.4.0"</span>,
  <span class="s2">"name"</span>: <span class="s2">"podman"</span>,
  <span class="s2">"plugins"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"bridge"</span>,
      <span class="s2">"bridge"</span>: <span class="s2">"cni-podman0"</span>,
      <span class="s2">"isGateway"</span>: <span class="nb">true</span>,
      <span class="s2">"ipMasq"</span>: <span class="nb">true</span>,
      <span class="s2">"hairpinMode"</span>: <span class="nb">true</span>,
      <span class="s2">"ipam"</span>: <span class="o">{</span>
        <span class="s2">"type"</span>: <span class="s2">"host-local"</span>,
        <span class="s2">"routes"</span>: <span class="o">[{</span> <span class="s2">"dst"</span>: <span class="s2">"0.0.0.0/0"</span> <span class="o">}]</span>,
        <span class="s2">"ranges"</span>: <span class="o">[</span>
          <span class="o">[</span>
            <span class="o">{</span>
              <span class="s2">"subnet"</span>: <span class="s2">"10.88.0.0/16"</span>,
              <span class="s2">"gateway"</span>: <span class="s2">"10.88.0.1"</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"portmap"</span>,
      <span class="s2">"capabilities"</span>: <span class="o">{</span>
        <span class="s2">"portMappings"</span>: <span class="nb">true</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"firewall"</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"tuning"</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
<span class="err">$</span>
</code></pre></div></div>

<p>From this, it is clear that while starting the minikube cluster, those two Pods got the IP from the Podman CNI, which seems to compete with the Calico CNI.</p>

<p>This issue is reported here: https://github.com/kubernetes/kubernetes/issues/107687</p>

<p>Let us create a new Pod in the default namespace and check which IP will be obtained.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx
pod/nginx created
</code></pre></div></div>
<p>Verify the IP of the new Pod and the node on which it got hosted.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get pods <span class="nt">-o</span> wide
NAME    READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES
nginx   1/1     Running   0          56s   10.244.205.193   minikube-m02   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>The new nginx pod got the IP address of <code class="language-plaintext highlighter-rouge">10.244.205.193</code> and is running on the <code class="language-plaintext highlighter-rouge">minikube-m02</code> node.</p>

<p>Let us log in to this <code class="language-plaintext highlighter-rouge">minikube-m02</code> node and verify the routing table and list of interfaces.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m02
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 22:a7:1a:d9:be:42 brd ff:ff:ff:ff:ff:ff
    inet 172.16.30.7/24 brd 172.16.30.255 scope global dynamic eth0
       valid_lft 84337sec preferred_lft 84337sec
3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:d3:aa:60:ec brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
5: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
    inet 10.244.205.192/32 scope global tunl0
       valid_lft forever preferred_lft forever
8: calic440f455693@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 0
$ ip route
default via 172.16.30.1 dev eth0 proto dhcp src 172.16.30.7 metric 1024
10.244.120.64/26 via 172.16.30.6 dev tunl0 proto bird onlink
10.244.151.0/26 via 172.16.30.8 dev tunl0 proto bird onlink
blackhole 10.244.205.192/26 proto bird
10.244.205.193 dev calic440f455693 scope link
172.16.30.0/24 dev eth0 proto kernel scope link src 172.16.30.7
172.16.30.1 dev eth0 proto dhcp scope link src 172.16.30.7 metric 1024
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
$
</span></code></pre></div></div>

<p>There are two special interfaces, <code class="language-plaintext highlighter-rouge">5: tunl0@NONE:</code> and <code class="language-plaintext highlighter-rouge">8: calic440f455693@if5:</code>. We can see that it is an <code class="language-plaintext highlighter-rouge">ipip</code> tunnel and tunnel interface (<code class="language-plaintext highlighter-rouge">tunl0</code>) has the IP address of <code class="language-plaintext highlighter-rouge">10.244.205.192/32</code>.</p>

<p>From the routing table, there are two /26 routes pointing to the <code class="language-plaintext highlighter-rouge">tunl0</code> interface. The <code class="language-plaintext highlighter-rouge">10.244.120.64/26 via 172.16.30.6</code> and <code class="language-plaintext highlighter-rouge">10.244.151.0/26 via 172.16.30.8</code> entries in the routing table, shows  the <code class="language-plaintext highlighter-rouge">Calico</code> assigned subnets on the other two nodes, and the routes for those remote subnets via the <code class="language-plaintext highlighter-rouge">IPIP</code> tunnel interface.</p>

<p>From within the <code class="language-plaintext highlighter-rouge">minikube-m02</code> node, issue the <code class="language-plaintext highlighter-rouge">docker ps</code> command the retrieve the container ID of the <code class="language-plaintext highlighter-rouge">nginx</code> container.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS     NAMES
0d1f5d390956   nginx                  <span class="s2">"/docker-entrypoint.‚Ä¶"</span>   28 minutes ago   Up 28 minutes             k8s_nginx_nginx_default_5c5b022b-70d0-4e59-bbba-35a9bb43aa5c_0
6b67d9586b86   k8s.gcr.io/pause:3.6   <span class="s2">"/pause"</span>                 28 minutes ago   Up 28 minutes             k8s_POD_nginx_default_5c5b022b-70d0-4e59-bbba-35a9bb43aa5c_0
6f65ec9ee321   5ef66b403f4f           <span class="s2">"start_runit"</span>            39 minutes ago   Up 39 minutes             k8s_calico-node_calico-node-gqvw6_kube-system_6a835837-d36e-4366-aefe-cedc09d2f148_1
3d0be715b116   9b7cc9982109           <span class="s2">"/usr/local/bin/kube‚Ä¶"</span>   41 minutes ago   Up 41 minutes             k8s_kube-proxy_kube-proxy-gm2dh_kube-system_770d601e-7b93-42fa-8019-5976ae95684e_0
9c077d1f8374   k8s.gcr.io/pause:3.6   <span class="s2">"/pause"</span>                 41 minutes ago   Up 41 minutes             k8s_POD_calico-node-gqvw6_kube-system_6a835837-d36e-4366-aefe-cedc09d2f148_0
4b2360ad79a9   k8s.gcr.io/pause:3.6   <span class="s2">"/pause"</span>                 41 minutes ago   Up 41 minutes             k8s_POD_kube-proxy-gm2dh_kube-system_770d601e-7b93-42fa-8019-5976ae95684e_0
<span class="err">$</span>
</code></pre></div></div>

<p>Get the <code class="language-plaintext highlighter-rouge">Pid</code> of the <code class="language-plaintext highlighter-rouge">nginx</code> container with the <code class="language-plaintext highlighter-rouge">docker inspect</code> command.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker inspect 0d1f5d390956 | <span class="nb">grep </span>Pid
            <span class="s2">"Pid"</span>: 11380,
            <span class="s2">"PidMode"</span>: <span class="s2">""</span>,
            <span class="s2">"PidsLimit"</span>: null,
<span class="err">$</span>
</code></pre></div></div>

<p>With the <code class="language-plaintext highlighter-rouge">nsenter</code> command, verify the list of interfaces inside the <code class="language-plaintext highlighter-rouge">nginx</code> container.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 11380 <span class="nt">-n</span> ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/sit 0.0.0.0 brd 0.0.0.0
3: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ipip 0.0.0.0 brd 0.0.0.0
5: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default
    <span class="nb">link</span>/ether e6:ea:af:be:ec:53 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.244.205.193/32 brd 10.244.205.193 scope global eth0
       valid_lft forever preferred_lft forever
<span class="err">$</span>
</code></pre></div></div>

<p>We can see that the Pod IP is configured on the <code class="language-plaintext highlighter-rouge">5: eth0@if8:</code> interface. From the <code class="language-plaintext highlighter-rouge">@if8</code>, we can see the link to the <code class="language-plaintext highlighter-rouge">8: calic440f455693@if5:</code> interface on the host (like the <code class="language-plaintext highlighter-rouge">veth</code> interfaces in the case of Kindnet CNI).</p>

<p>Look at the routing table of the <code class="language-plaintext highlighter-rouge">nginx</code> pod.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 11380 <span class="nt">-n</span> ip route
default via 169.254.1.1 dev eth0
169.254.1.1 dev eth0 scope <span class="nb">link</span>
<span class="err">$</span>
</code></pre></div></div>

<p>Exit the <code class="language-plaintext highlighter-rouge">minikube-m02</code> node and use the <code class="language-plaintext highlighter-rouge">kubectl describe nodes</code> command and filter for the PodCIDRs.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl describe nodes | <span class="nb">grep</span> <span class="nt">-e</span> Name <span class="nt">-e</span> PodCIDR
Name:               minikube
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
  Namespace                   Name                                        CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
Name:               minikube-m02
PodCIDR:                      10.244.1.0/24
PodCIDRs:                     10.244.1.0/24
  Namespace                   Name                 CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
Name:               minikube-m03
PodCIDR:                      10.244.2.0/24
PodCIDRs:                     10.244.2.0/24
  Namespace                   Name                 CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>Currently, there is only one pod (<code class="language-plaintext highlighter-rouge">nginx</code>) in the cluster. Similar to what we have verified on the <code class="language-plaintext highlighter-rouge">minikube-m02</code> node, do the same on the other two nodes as well.</p>

<p>From the <code class="language-plaintext highlighter-rouge">minikube</code> node:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 9e:55:51:7f:e1:98 brd ff:ff:ff:ff:ff:ff
    inet 172.16.30.6/24 brd 172.16.30.255 scope global dynamic eth0
       valid_lft 82845sec preferred_lft 82845sec
3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:92:37:51:98 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
5: cni-podman0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 36:85:e8:76:d2:1c brd ff:ff:ff:ff:ff:ff
    inet 10.88.0.1/16 brd 10.88.255.255 scope global cni-podman0
       valid_lft forever preferred_lft forever
6: veth5a561323@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master cni-podman0 state UP group default
    link/ether f6:67:49:87:51:36 brd ff:ff:ff:ff:ff:ff link-netnsid 0
7: vethb6ed82ba@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master cni-podman0 state UP group default
    link/ether 22:b5:fe:8a:37:59 brd ff:ff:ff:ff:ff:ff link-netnsid 1
8: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
    inet 10.244.120.64/32 scope global tunl0
       valid_lft forever preferred_lft forever
$ ip route
default via 172.16.30.1 dev eth0 proto dhcp src 172.16.30.6 metric 1024
10.88.0.0/16 dev cni-podman0 proto kernel scope link src 10.88.0.1
blackhole 10.244.120.64/26 proto bird
10.244.151.0/26 via 172.16.30.8 dev tunl0 proto bird onlink
10.244.205.192/26 via 172.16.30.7 dev tunl0 proto bird onlink
172.16.30.0/24 dev eth0 proto kernel scope link src 172.16.30.6
172.16.30.1 dev eth0 proto dhcp scope link src 172.16.30.6 metric 1024
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
$ exit
logout
pradeep@learnk8s$
</span></code></pre></div></div>
<p>On the <code class="language-plaintext highlighter-rouge">controlplane</code> node, there are extra interfaces coming from the <code class="language-plaintext highlighter-rouge">Podman CNI</code>.</p>

<p>From the <code class="language-plaintext highlighter-rouge">minikube-m03</code> node:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m03
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether de:b8:1d:5e:d9:c0 brd ff:ff:ff:ff:ff:ff
    inet 172.16.30.8/24 brd 172.16.30.255 scope global dynamic eth0
       valid_lft 83040sec preferred_lft 83040sec
3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:66:0b:71:73 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
5: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
    inet 10.244.151.0/32 scope global tunl0
       valid_lft forever preferred_lft forever
$ ip route
default via 172.16.30.1 dev eth0 proto dhcp src 172.16.30.8 metric 1024
10.244.120.64/26 via 172.16.30.6 dev tunl0 proto bird onlink
blackhole 10.244.151.0/26 proto bird
10.244.205.192/26 via 172.16.30.7 dev tunl0 proto bird onlink
172.16.30.0/24 dev eth0 proto kernel scope link src 172.16.30.8
172.16.30.1 dev eth0 proto dhcp scope link src 172.16.30.8 metric 1024
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
$
</span></code></pre></div></div>
<p>On other nodes also, we do see similar <code class="language-plaintext highlighter-rouge">tunl0</code> interface and routes for Calico subnets (/26s) via the <code class="language-plaintext highlighter-rouge">IPIP</code> tunnel.
For the local subnet, there is a <code class="language-plaintext highlighter-rouge">blackhole</code> route: for example on the <code class="language-plaintext highlighter-rouge">minikube-m03</code> node <code class="language-plaintext highlighter-rouge">blackhole 10.244.151.0/26 proto bird</code>, and on <code class="language-plaintext highlighter-rouge">minikube-m02</code> node <code class="language-plaintext highlighter-rouge">blackhole 10.244.205.192/26 proto bird</code>, on the <code class="language-plaintext highlighter-rouge">minikube</code> node <code class="language-plaintext highlighter-rouge">blackhole 10.244.120.64/26 proto bird</code>.</p>

<p>Let us manually schedule a Pod on the <code class="language-plaintext highlighter-rouge">minikube-m03</code> node.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">pradeep@learnk8s$ cat my-pod.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-manual</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeName</span><span class="pi">:</span> <span class="s">minikube-m03</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl create <span class="nt">-f</span> my-pod.yaml
pod/nginx-manual created
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get pods <span class="nt">-o</span> wide
NAME           READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES
nginx          1/1     Running   0          53m   10.244.205.193   minikube-m02   &lt;none&gt;           &lt;none&gt;
nginx-manual   1/1     Running   0          39s   10.244.151.1     minikube-m03   &lt;none&gt;           &lt;none&gt;
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>As expected, the <code class="language-plaintext highlighter-rouge">nginx-manual</code> pod got an IP from the <code class="language-plaintext highlighter-rouge">10.244.151.0/26</code> subnet.</p>

<p>Log back to the <code class="language-plaintext highlighter-rouge">minikube-m03</code> node and check the routing table and list of interfaces.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m03
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether de:b8:1d:5e:d9:c0 brd ff:ff:ff:ff:ff:ff
    inet 172.16.30.8/24 brd 172.16.30.255 scope global dynamic eth0
       valid_lft 82414sec preferred_lft 82414sec
3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:66:0b:71:73 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
5: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
    inet 10.244.151.0/32 scope global tunl0
       valid_lft forever preferred_lft forever
8: califba6dd09590@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 0
$ ip route
default via 172.16.30.1 dev eth0 proto dhcp src 172.16.30.8 metric 1024
10.244.120.64/26 via 172.16.30.6 dev tunl0 proto bird onlink
blackhole 10.244.151.0/26 proto bird
10.244.151.1 dev califba6dd09590 scope link
10.244.205.192/26 via 172.16.30.7 dev tunl0 proto bird onlink
172.16.30.0/24 dev eth0 proto kernel scope link src 172.16.30.8
172.16.30.1 dev eth0 proto dhcp scope link src 172.16.30.8 metric 1024
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
$
</span></code></pre></div></div>

<p>Compared to the previous output (when there were no pods on this node), there is a new interface <code class="language-plaintext highlighter-rouge">8: califba6dd09590@if5:</code> and new route entry for the Pod IP <code class="language-plaintext highlighter-rouge">10.244.151.1 dev califba6dd09590 scope link</code>.</p>

<p>Get the container ID and Pid of this <code class="language-plaintext highlighter-rouge">nginx-manual</code> container.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED             STATUS             PORTS     NAMES
244b50fad9d4   nginx                  <span class="s2">"/docker-entrypoint.‚Ä¶"</span>   5 minutes ago       Up 5 minutes                 k8s_nginx_nginx-manual_default_ffbeaf88-b368-48af-b181-fc30cb49406a_0
e7117e519923   k8s.gcr.io/pause:3.6   <span class="s2">"/pause"</span>                 5 minutes ago       Up 5 minutes                 k8s_POD_nginx-manual_default_ffbeaf88-b368-48af-b181-fc30cb49406a_0
c4c993bc1f2e   calico/node            <span class="s2">"start_runit"</span>            About an hour ago   Up About an hour             k8s_calico-node_calico-node-sw74l_kube-system_0e30bbad-8370-4907-ab20-ce81450ad13c_0
a3482f106e3a   9b7cc9982109           <span class="s2">"/usr/local/bin/kube‚Ä¶"</span>   About an hour ago   Up About an hour             k8s_kube-proxy_kube-proxy-7k4lb_kube-system_f284e305-e71b-40b0-a715-796d0733bc03_0
25a914d158da   k8s.gcr.io/pause:3.6   <span class="s2">"/pause"</span>                 About an hour ago   Up About an hour             k8s_POD_calico-node-sw74l_kube-system_0e30bbad-8370-4907-ab20-ce81450ad13c_0
abce35d2a0ae   k8s.gcr.io/pause:3.6   <span class="s2">"/pause"</span>                 About an hour ago   Up About an hour             k8s_POD_kube-proxy-7k4lb_kube-system_f284e305-e71b-40b0-a715-796d0733bc03_0
<span class="err">$</span>
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker inspect 244b50fad9d4 | <span class="nb">grep </span>Pid
            <span class="s2">"Pid"</span>: 42125,
            <span class="s2">"PidMode"</span>: <span class="s2">""</span>,
            <span class="s2">"PidsLimit"</span>: null,
<span class="err">$</span>
</code></pre></div></div>

<p>Use the <code class="language-plaintext highlighter-rouge">nsenter</code> command and verify the Pod interfaces and route table.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nsenter <span class="nt">-t</span> 42125 <span class="nt">-n</span> ip a
nsenter: cannot open /proc/42125/ns/net: Permission denied
<span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 42125 <span class="nt">-n</span> ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/sit 0.0.0.0 brd 0.0.0.0
3: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ipip 0.0.0.0 brd 0.0.0.0
5: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default
    <span class="nb">link</span>/ether 9a:93:7b:77:8f:c7 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.244.151.1/32 brd 10.244.151.1 scope global eth0
       valid_lft forever preferred_lft forever
<span class="err">$</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">eth0</code> interface (<code class="language-plaintext highlighter-rouge">5: eth0@if8</code>) of the Pod has the IP address <code class="language-plaintext highlighter-rouge">10.244.151.1/32</code> and is mapped to the  new <code class="language-plaintext highlighter-rouge">cali</code> interface <code class="language-plaintext highlighter-rouge">8: califba6dd09590@if5:</code> on the host.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 42125 <span class="nt">-n</span> ip route
default via 169.254.1.1 dev eth0
169.254.1.1 dev eth0 scope <span class="nb">link</span>
<span class="err">$</span>
</code></pre></div></div>
<p>Verify communication between the two Pods. <code class="language-plaintext highlighter-rouge">10.244.205.193</code> is the IP address of the <code class="language-plaintext highlighter-rouge">nginx</code> pod running on the other node <code class="language-plaintext highlighter-rouge">minikube-m02</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 42125 <span class="nt">-n</span> ping 10.244.205.193
PING 10.244.205.193 <span class="o">(</span>10.244.205.193<span class="o">)</span>: 56 data bytes
64 bytes from 10.244.205.193: <span class="nb">seq</span><span class="o">=</span>0 <span class="nv">ttl</span><span class="o">=</span>62 <span class="nb">time</span><span class="o">=</span>17.321 ms
64 bytes from 10.244.205.193: <span class="nb">seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>62 <span class="nb">time</span><span class="o">=</span>0.963 ms
64 bytes from 10.244.205.193: <span class="nb">seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>62 <span class="nb">time</span><span class="o">=</span>0.891 ms
64 bytes from 10.244.205.193: <span class="nb">seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>62 <span class="nb">time</span><span class="o">=</span>1.529 ms
^C
<span class="nt">---</span> 10.244.205.193 ping statistics <span class="nt">---</span>
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max <span class="o">=</span> 0.891/5.176/17.321 ms
<span class="err">$</span>
</code></pre></div></div>
<p>Verify communication to the outside cluster hosts, like any internet host ( for example 8.8.8.8)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 42125 <span class="nt">-n</span> ping 8.8.8.8
PING 8.8.8.8 <span class="o">(</span>8.8.8.8<span class="o">)</span>: 56 data bytes
64 bytes from 8.8.8.8: <span class="nb">seq</span><span class="o">=</span>0 <span class="nv">ttl</span><span class="o">=</span>115 <span class="nb">time</span><span class="o">=</span>20.260 ms
64 bytes from 8.8.8.8: <span class="nb">seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>115 <span class="nb">time</span><span class="o">=</span>15.457 ms
^C
<span class="nt">---</span> 8.8.8.8 ping statistics <span class="nt">---</span>
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max <span class="o">=</span> 15.457/17.858/20.260 ms
<span class="err">$</span>
</code></pre></div></div>
<p>Let us install <code class="language-plaintext highlighter-rouge">calicoctl</code> as a Pod itself.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://projectcalico.docs.tigera.io/manifests/calicoctl.yaml
serviceaccount/calicoctl created
pod/calicoctl created
clusterrole.rbac.authorization.k8s.io/calicoctl created
clusterrolebinding.rbac.authorization.k8s.io/calicoctl created
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>
<p>Verify that the <code class="language-plaintext highlighter-rouge">calicoctl</code> pod is running.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get pods <span class="nt">-n</span> kube-system <span class="nt">-o</span> wide
NAME                                       READY   STATUS    RESTARTS      AGE   IP            NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-8594699699-dztlm   1/1     Running   0             82m   10.88.0.3     minikube       &lt;none&gt;           &lt;none&gt;
calico-node-gqvw6                          1/1     Running   1 <span class="o">(</span>78m ago<span class="o">)</span>   80m   172.16.30.7   minikube-m02   &lt;none&gt;           &lt;none&gt;
calico-node-qdbcf                          1/1     Running   0             82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
calico-node-sw74l                          1/1     Running   0             77m   172.16.30.8   minikube-m03   &lt;none&gt;           &lt;none&gt;
calicoctl                                  1/1     Running   0             18s   172.16.30.7   minikube-m02   &lt;none&gt;           &lt;none&gt;
coredns-64897985d-58btq                    1/1     Running   0             82m   10.88.0.2     minikube       &lt;none&gt;           &lt;none&gt;
etcd-minikube                              1/1     Running   0             82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-apiserver-minikube                    1/1     Running   0             82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-controller-manager-minikube           1/1     Running   0             82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-proxy-7k4lb                           1/1     Running   0             77m   172.16.30.8   minikube-m03   &lt;none&gt;           &lt;none&gt;
kube-proxy-gm2dh                           1/1     Running   0             80m   172.16.30.7   minikube-m02   &lt;none&gt;           &lt;none&gt;
kube-proxy-hvkqd                           1/1     Running   0             82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
kube-scheduler-minikube                    1/1     Running   0             82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
storage-provisioner                        1/1     Running   1 <span class="o">(</span>77m ago<span class="o">)</span>   82m   172.16.30.6   minikube       &lt;none&gt;           &lt;none&gt;
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>Verify the <code class="language-plaintext highlighter-rouge">calicoctl</code></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system calicoctl <span class="nt">--</span> /calicoctl get nodes <span class="nt">-o</span> wide
Failed to get resources: Version mismatch.
Client Version:   v3.22.1
Cluster Version:  v3.20.0
Use <span class="nt">--allow-version-mismatch</span> to override.

<span class="nb">command </span>terminated with <span class="nb">exit </span>code 1
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>Repeat it with <code class="language-plaintext highlighter-rouge">--allow-version-mismatch</code>.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system calicoctl <span class="nt">--</span> /calicoctl get nodes <span class="nt">-o</span> wide <span class="nt">--allow-version-mismatch</span>
NAME           ASN       IPV4             IPV6
minikube       <span class="o">(</span>64512<span class="o">)</span>   172.16.30.6/24
minikube-m02   <span class="o">(</span>64512<span class="o">)</span>   172.16.30.7/24
minikube-m03   <span class="o">(</span>64512<span class="o">)</span>   172.16.30.8/24

pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>We can confirm that the <code class="language-plaintext highlighter-rouge">calicoctl</code> is working and we can see some BGP Autonomous systems shown as well. Currently all three nodes are part of the same ASN (<code class="language-plaintext highlighter-rouge">64512</code>).</p>

<p>Create an alias for the <code class="language-plaintext highlighter-rouge">calicoctl</code></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span><span class="nb">alias </span><span class="nv">calicoctl</span><span class="o">=</span><span class="s2">"kubectl exec -i -n kube-system calicoctl -- /calicoctl --allow-version-mismatch"</span>
</code></pre></div></div>

<p>By default, calicoctl will attempt to read from the Kubernetes API using the default kubeconfig located at $(HOME)/.kube/config.</p>

<p>If the default kubeconfig does not exist, or you would like to specify alternative API access information, you can do so using the following configuration options.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ DATASTORE_TYPE</span><span class="o">=</span>kubernetes <span class="nv">KUBECONFIG</span><span class="o">=</span>~/.kube/config calicoctl get nodes
NAME
minikube
minikube-m02
minikube-m03

pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>Verify all API-Resources installed by <code class="language-plaintext highlighter-rouge">Calico</code> CNI plugin.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl api-resources | <span class="nb">grep </span>calico
bgpconfigurations                              crd.projectcalico.org/v1               <span class="nb">false        </span>BGPConfiguration
bgppeers                                       crd.projectcalico.org/v1               <span class="nb">false        </span>BGPPeer
blockaffinities                                crd.projectcalico.org/v1               <span class="nb">false        </span>BlockAffinity
clusterinformations                            crd.projectcalico.org/v1               <span class="nb">false        </span>ClusterInformation
felixconfigurations                            crd.projectcalico.org/v1               <span class="nb">false        </span>FelixConfiguration
globalnetworkpolicies                          crd.projectcalico.org/v1               <span class="nb">false        </span>GlobalNetworkPolicy
globalnetworksets                              crd.projectcalico.org/v1               <span class="nb">false        </span>GlobalNetworkSet
hostendpoints                                  crd.projectcalico.org/v1               <span class="nb">false        </span>HostEndpoint
ipamblocks                                     crd.projectcalico.org/v1               <span class="nb">false        </span>IPAMBlock
ipamconfigs                                    crd.projectcalico.org/v1               <span class="nb">false        </span>IPAMConfig
ipamhandles                                    crd.projectcalico.org/v1               <span class="nb">false        </span>IPAMHandle
ippools                                        crd.projectcalico.org/v1               <span class="nb">false        </span>IPPool
kubecontrollersconfigurations                  crd.projectcalico.org/v1               <span class="nb">false        </span>KubeControllersConfiguration
networkpolicies                                crd.projectcalico.org/v1               <span class="nb">true         </span>NetworkPolicy
networksets                                    crd.projectcalico.org/v1               <span class="nb">true         </span>NetworkSet
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>
<p>Verify some of these resources with <code class="language-plaintext highlighter-rouge">kubectl get</code> and <code class="language-plaintext highlighter-rouge">kubectl describe</code> commands.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get bgppeers <span class="nt">-A</span>
No resources found
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get ippools
NAME                  AGE
default-ipv4-ippool   97m
pradeep@learnk8s<span class="nv">$ </span>kubectl describe ippools
Name:         default-ipv4-ippool
Namespace:
Labels:       &lt;none&gt;
Annotations:  projectcalico.org/metadata: <span class="o">{</span><span class="s2">"uid"</span>:<span class="s2">"cf94cf43-8887-4528-a934-ca498f0422e1"</span>,<span class="s2">"creationTimestamp"</span>:<span class="s2">"2022-03-19T18:20:36Z"</span><span class="o">}</span>
API Version:  crd.projectcalico.org/v1
Kind:         IPPool
Metadata:
  Creation Timestamp:  2022-03-19T18:20:36Z
  Generation:          1
  Managed Fields:
    API Version:  crd.projectcalico.org/v1
    Fields Type:  FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .:
          f:projectcalico.org/metadata:
      f:spec:
        .:
        f:blockSize:
        f:cidr:
        f:ipipMode:
        f:natOutgoing:
        f:nodeSelector:
        f:vxlanMode:
    Manager:         Go-http-client
    Operation:       Update
    Time:            2022-03-19T18:20:36Z
  Resource Version:  659
  UID:               8d9e076a-dae6-4bbd-8f44-920da83472ba
Spec:
  Block Size:     26
  Cidr:           10.244.0.0/16
  Ipip Mode:      Always
  Nat Outgoing:   <span class="nb">true
  </span>Node Selector:  all<span class="o">()</span>
  Vxlan Mode:     Never
Events:           &lt;none&gt;
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get ipamblocks
NAME                AGE
10-244-120-64-26    98m
10-244-151-0-26     93m
10-244-205-192-26   95m
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>
<p>We have seen these IPAM blocks already, when we verified the routing tables on each node.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get networkpolicies
No resources found <span class="k">in </span>default namespace.
</code></pre></div></div>

<p>Let us create a network policy now.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">pradeep@learnk8s$ cat network-policy.yaml</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-deny-ingress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
<span class="s">pradeep@learnk8s$</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl create <span class="nt">-f</span> network-policy.yaml
networkpolicy.networking.k8s.io/default-deny-ingress created
</code></pre></div></div>
<p>Verify that the network policy is created.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get netpol
NAME                   POD-SELECTOR   AGE
default-deny-ingress   &lt;none&gt;         2s
</code></pre></div></div>
<p>Describe it for more details.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl describe netpol
Name:         default-deny-ingress
Namespace:    default
Created on:   2022-03-20 01:45:29 +0530 IST
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Spec:
  PodSelector:     &lt;none&gt; <span class="o">(</span>Allowing the specific traffic to all pods <span class="k">in </span>this namespace<span class="o">)</span>
  Allowing ingress traffic:
    &lt;none&gt; <span class="o">(</span>Selected pods are isolated <span class="k">for </span>ingress connectivity<span class="o">)</span>
  Not affecting egress traffic
  Policy Types: Ingress
pradeep@learnk8s<span class="nv">$ </span><span class="nb">cat </span>network-policy.yaml
<span class="nt">---</span>
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: <span class="o">{}</span>
  policyTypes:
  - Ingress
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>
<p>If you recall, we have two pods in our cluster at the moment.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get pods <span class="nt">-o</span> wide
NAME           READY   STATUS    RESTARTS   AGE    IP               NODE           NOMINATED NODE   READINESS GATES
nginx          1/1     Running   0          105m   10.244.205.193   minikube-m02   &lt;none&gt;           &lt;none&gt;
nginx-manual   1/1     Running   0          52m    10.244.151.1     minikube-m03   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>Now that the network policy is applied, let us check the connectivity between these two pods again.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m02
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ docker ps | grep nginx
0d1f5d390956   nginx                  "/docker-entrypoint.‚Ä¶"   2 hours ago      Up 2 hours                k8s_nginx_nginx_default_5c5b022b-70d0-4e59-bbba-35a9bb43aa5c_0
6b67d9586b86   k8s.gcr.io/pause:3.6   "/pause"                 2 hours ago      Up 2 hours                k8s_POD_nginx_default_5c5b022b-70d0-4e59-bbba-35a9bb43aa5c_0
$ docker inspect 0d1f5d390956 | grep Pid
            "Pid": 11380,
            "PidMode": "",
            "PidsLimit": null,
$ sudo nsenter -t 11380 -n ping 10.244.151.1
PING 10.244.151.1 (10.244.151.1): 56 data bytes
^C
--- 10.244.151.1 ping statistics ---
3 packets transmitted, 0 packets received, 100% packet loss
$
</span></code></pre></div></div>
<p>From <code class="language-plaintext highlighter-rouge">nginx</code> pod, we are not able to ping to <code class="language-plaintext highlighter-rouge">nginx-manual</code> pod.</p>

<p>Similarly, verify the other way, ping from <code class="language-plaintext highlighter-rouge">nginx-manual</code> to <code class="language-plaintext highlighter-rouge">nginx</code> Pod (which was working earlier, that we tested already!).</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m03
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ docker ps | grep nginx
244b50fad9d4   nginx                  "/docker-entrypoint.‚Ä¶"   55 minutes ago   Up 55 minutes             k8s_nginx_nginx-manual_default_ffbeaf88-b368-48af-b181-fc30cb49406a_0
e7117e519923   k8s.gcr.io/pause:3.6   "/pause"                 55 minutes ago   Up 55 minutes             k8s_POD_nginx-manual_default_ffbeaf88-b368-48af-b181-fc30cb49406a_0
$ docker inspect 244b50fad9d4 | grep Pid
            "Pid": 42125,
            "PidMode": "",
            "PidsLimit": null,
$ sudo nsenter -t 42125 -n ping 10.244.205.193
PING 10.244.205.193 (10.244.205.193): 56 data bytes
^C
--- 10.244.205.193 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
$ exit 0
logout
pradeep@learnk8s$
</span></code></pre></div></div>

<p>With network policy applied, the communication is blocked.</p>

<p>Let us create another network policy, this time to allow all ingress.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">pradeep@learnk8s$ cat allow-ingress.yaml</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">allow-all-ingress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{}</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>

</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl create <span class="nt">-f</span> allow-ingress.yaml
networkpolicy.networking.k8s.io/allow-all-ingress created
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl get netpol
NAME                   POD-SELECTOR   AGE
allow-all-ingress      &lt;none&gt;         5s
default-deny-ingress   &lt;none&gt;         11m
</code></pre></div></div>

<p>Describe the new policy.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>kubectl describe netpol allow-all-ingress
Name:         allow-all-ingress
Namespace:    default
Created on:   2022-03-20 01:56:32 +0530 IST
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Spec:
  PodSelector:     &lt;none&gt; <span class="o">(</span>Allowing the specific traffic to all pods <span class="k">in </span>this namespace<span class="o">)</span>
  Allowing ingress traffic:
    To Port: &lt;any&gt; <span class="o">(</span>traffic allowed to all ports<span class="o">)</span>
    From: &lt;any&gt; <span class="o">(</span>traffic not restricted by <span class="nb">source</span><span class="o">)</span>
  Not affecting egress traffic
  Policy Types: Ingress
pradeep@learnk8s<span class="err">$</span>
</code></pre></div></div>

<p>Now that we have allowed the ingress traffic to all pods/all ports.</p>

<p>Verify again. Now that we know the Pid of the containers, those steps are not needed.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m02
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ sudo nsenter -t 11380 -n ping 10.244.151.1
PING 10.244.151.1 (10.244.151.1): 56 data bytes
64 bytes from 10.244.151.1: seq=0 ttl=62 time=3.834 ms
64 bytes from 10.244.151.1: seq=1 ttl=62 time=1.409 ms
64 bytes from 10.244.151.1: seq=2 ttl=62 time=0.723 ms
^C
--- 10.244.151.1 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 0.723/1.988/3.834 ms
$ exit 0
logout
</span></code></pre></div></div>
<p>Yay! Ping is working again.</p>

<p>Similarly, verify in the other direction.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pradeep@learnk8s<span class="nv">$ </span>minikube ssh <span class="nt">-n</span> minikube-m03
                         _             _
            _         _ <span class="o">(</span> <span class="o">)</span>           <span class="o">(</span> <span class="o">)</span>
  ___ ___  <span class="o">(</span>_<span class="o">)</span>  ___  <span class="o">(</span>_<span class="o">)</span>| |/<span class="s1">')  _   _ | |_      __
/'</span> _ <span class="sb">`</span> _ <span class="sb">`</span><span class="se">\|</span> |/<span class="s1">' _ `\| || , &lt;  ( ) ( )| '</span>_<span class="sb">`</span><span class="se">\ </span> /<span class="s1">'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'</span><span class="o">(</span>_,__/<span class="s1">'`\____)

$ sudo nsenter -t 42125 -n ping 10.244.205.193
PING 10.244.205.193 (10.244.205.193): 56 data bytes
64 bytes from 10.244.205.193: seq=0 ttl=62 time=1.132 ms
64 bytes from 10.244.205.193: seq=1 ttl=62 time=1.672 ms
64 bytes from 10.244.205.193: seq=2 ttl=62 time=1.695 ms
^C
--- 10.244.205.193 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 1.132/1.499/1.695 ms
$ exit 0
logout
</span></code></pre></div></div>

<p>This completes our initial discussion on the Calico CNI. We just scratched the surface of it, there are many more features, which will be discussed in other posts.</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/tags/#minikube" class="page__taxonomy-item p-category" rel="tag">minikube</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/categories/#kubernetes" class="page__taxonomy-item p-category" rel="tag">Kubernetes</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2022-03-19T10:55:04+05:30">March 19, 2022</time></p>

      </footer>
      <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Kubernetes+Networking+with+Calico+CNI%20https%3A%2F%2Fwww.pradeepgadde.com%2Fblog%2Fkubernetes%2F2022%2F03%2F19%2Fkubernetes-networking-calico.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.pradeepgadde.com%2Fblog%2Fkubernetes%2F2022%2F03%2F19%2Fkubernetes-networking-calico.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.pradeepgadde.com%2Fblog%2Fkubernetes%2F2022%2F03%2F19%2Fkubernetes-networking-calico.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/kubernetes/2022/03/01/kubernetes-rollout.html" class="pagination--pager" title="Kubectl Rollout
">Previous</a>
    
    
      <a href="/blog/kubernetes/2022/03/19/kubernetes-networking.html" class="pagination--pager" title="Kubernetes Networking with Minikube (Kindnet CNI)
">Next</a>
    
  </nav>

      
    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/blog/assets/images/nginx-ingress.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/kubernetes/2022/03/21/kubernetes-ingress.html" rel="permalink">Kubernetes Ingress Controller
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-03-21T10:55:04+05:30">March 21, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          15 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Kubernetes Ingress Controller
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/blog/assets/images/coredns.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/kubernetes/2022/03/21/kubernetes-dns.html" rel="permalink">Kubernetes DNS
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-03-21T10:55:04+05:30">March 21, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Kubernetes DNS
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/blog/assets/images/kindnet.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/kubernetes/2022/03/19/kubernetes-networking.html" rel="permalink">Kubernetes Networking with Minikube (Kindnet CNI)
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-03-19T10:55:04+05:30">March 19, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Hello!
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/blog/assets/images/kubernetes.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/kubernetes/2022/03/01/kubernetes-rollout.html" rel="permalink">Kubectl Rollout
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-03-01T10:55:04+05:30">March 1, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Kubectl Rollout
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/junivator" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/pradeepgadde" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Pradeep Gadde. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>




<script src="/blog/assets/js/lunr/lunr.min.js"></script>
<script src="/blog/assets/js/lunr/lunr-store.js"></script>
<script src="/blog/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
